{% extends "base.html" %}

{% block title %}Delivery History - Webhook Admin{% endblock %}

{% block content %}
<div class="card">
    <h2>Webhook Delivery History</h2>
    <p>View delivery logs, retry attempts, and debug failed deliveries.</p>
</div>

<div class="card">
    <h3>Filters</h3>
    <div style="display: flex; gap: 15px; flex-wrap: wrap;">
        <div>
            <label for="statusFilter">Status</label>
            <select id="statusFilter" onchange="loadDeliveries()">
                <option value="">All</option>
                <option value="pending">Pending</option>
                <option value="delivered">Delivered</option>
                <option value="failed">Failed</option>
                <option value="dead_letter">Dead Letter</option>
            </select>
        </div>
        <div>
            <button onclick="loadDeliveries()" class="btn">Refresh</button>
        </div>
    </div>
</div>

<div class="card">
    <h3>Delivery Logs</h3>
    <div id="deliveriesList">
        <p>Loading...</p>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    const API_BASE = '/api/v1';
    let authToken = localStorage.getItem('apiKey') || 'Bearer demo-key';
    
    async function loadDeliveries() {
        const status = document.getElementById('statusFilter').value;
        const params = new URLSearchParams();
        if (status) params.append('status', status);
        
        try {
            const response = await fetch(`${API_BASE}/webhooks/deliveries/?${params}`, {
                headers: {
                    'Authorization': authToken
                }
            });
            
            if (!response.ok) throw new Error('Failed to load deliveries');
            
            const deliveries = await response.json();
            displayDeliveries(deliveries);
        } catch (error) {
            document.getElementById('deliveriesList').innerHTML = `<p style="color: #e74c3c;">Error loading deliveries. Make sure you're authenticated.</p>`;
        }
    }
    
    function displayDeliveries(deliveries) {
        if (deliveries.length === 0) {
            document.getElementById('deliveriesList').innerHTML = '<p>No delivery logs found.</p>';
            return;
        }
        
        const table = `
            <table>
                <thead>
                    <tr>
                        <th>Event Type</th>
                        <th>Status</th>
                        <th>Attempts</th>
                        <th>Response</th>
                        <th>Created</th>
                        <th>Delivered</th>
                        <th>Next Retry</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    ${deliveries.map(delivery => `
                        <tr>
                            <td><span class="badge badge-info">${delivery.event_type}</span></td>
                            <td>
                                ${getStatusBadge(delivery.status)}
                            </td>
                            <td>${delivery.attempt_count} / ${delivery.max_attempts}</td>
                            <td>
                                ${delivery.response_status 
                                    ? `HTTP ${delivery.response_status}` 
                                    : delivery.error_message 
                                        ? `<span style="color: #e74c3c;" title="${delivery.error_message}">Error</span>`
                                        : '-'}
                            </td>
                            <td>${formatDate(delivery.created_at)}</td>
                            <td>${delivery.delivered_at ? formatDate(delivery.delivered_at) : '-'}</td>
                            <td>${delivery.next_retry_at ? formatDate(delivery.next_retry_at) : '-'}</td>
                            <td>
                                <button onclick="viewDetails('${delivery.id}')" class="btn">Details</button>
                            </td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>
        `;
        
        document.getElementById('deliveriesList').innerHTML = table;
    }
    
    function getStatusBadge(status) {
        const badges = {
            'pending': '<span class="badge badge-warning">Pending</span>',
            'delivered': '<span class="badge badge-success">Delivered</span>',
            'failed': '<span class="badge badge-danger">Failed</span>',
            'dead_letter': '<span class="badge badge-danger">Dead Letter</span>'
        };
        return badges[status] || status;
    }
    
    function formatDate(dateString) {
        const date = new Date(dateString);
        return date.toLocaleString();
    }
    
    function viewDetails(deliveryId) {
        alert('Viewing details for delivery: ' + deliveryId);
    }
    
    loadDeliveries();
    setInterval(loadDeliveries, 30000);
</script>
{% endblock %}
