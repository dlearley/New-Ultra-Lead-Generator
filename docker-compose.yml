version: "3.9"

services:
  postgres:
    image: pgvector/pgvector:pg16
    container_name: dev-postgres
    restart: unless-stopped
    env_file:
      - ./.env
    environment:
      PGDATA: /var/lib/postgresql/data/pgdata
    command:
      - "/bin/sh"
      - "-c"
      - "postgres -c shared_preload_libraries=vector ${POSTGRES_EXTRA_FLAGS:-}"
    ports:
      - "${POSTGRES_PORT:-5432}:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
    networks:
      - app-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U $${POSTGRES_USER:-postgres} -d $${POSTGRES_DB:-app_db}"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

  redis:
    image: redis:7.2-alpine
    container_name: dev-redis
    restart: unless-stopped
    env_file:
      - ./.env
    command:
      - "/bin/sh"
      - "-c"
      - "redis-server --save 60 1 --loglevel warning --requirepass ${REDIS_PASSWORD:-redislocal}"
    ports:
      - "${REDIS_PORT:-6379}:6379"
    volumes:
      - redis_data:/data
    networks:
      - app-network
    healthcheck:
      test: ["CMD-SHELL", "redis-cli -a ${REDIS_PASSWORD:-redislocal} ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  bullmq-dashboard:
    build:
      context: ./services/bullmq-dashboard
    container_name: dev-bullmq-dashboard
    restart: unless-stopped
    env_file:
      - ./.env
    environment:
      REDIS_HOST: ${REDIS_HOST:-redis}
      REDIS_PORT: ${REDIS_PORT:-6379}
      REDIS_PASSWORD: ${REDIS_PASSWORD:-redislocal}
      BULLMQ_DASHBOARD_PORT: ${BULLMQ_DASHBOARD_PORT:-3002}
      BULLMQ_DASHBOARD_USERNAME: ${BULLMQ_DASHBOARD_USERNAME:-ops}
      BULLMQ_DASHBOARD_PASSWORD: ${BULLMQ_DASHBOARD_PASSWORD:-super-secret}
      BULLMQ_QUEUES: ${BULLMQ_QUEUES:-default,emails,workflows}
    ports:
      - "${BULLMQ_DASHBOARD_PORT:-3002}:${BULLMQ_DASHBOARD_PORT:-3002}"
    depends_on:
      redis:
        condition: service_healthy
    networks:
      - app-network
    healthcheck:
      test: ["CMD", "wget", "-qO", "-", "http://localhost:${BULLMQ_DASHBOARD_PORT:-3002}/api/queues"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 15s

  opensearch:
    image: opensearchproject/opensearch:2.11.0
    container_name: dev-opensearch
    restart: unless-stopped
    env_file:
      - ./.env
    environment:
      discovery.type: single-node
      bootstrap.memory_lock: "true"
      OPENSEARCH_INITIAL_ADMIN_PASSWORD: ${OPENSEARCH_PASSWORD:-admin}
      OPENSEARCH_JAVA_OPTS: "${OPENSEARCH_JAVA_OPTS:--Xms512m -Xmx512m}"
      plugins.security.ssl.http.enabled: "false"
      plugins.security.disabled: "false"
      plugins.security.allow_default_init_securityindex: "true"
    ulimits:
      memlock:
        soft: -1
        hard: -1
      nofile:
        soft: 65536
        hard: 65536
    ports:
      - "${OPENSEARCH_PORT:-9200}:9200"
      - "9600:9600"
    volumes:
      - opensearch_data:/usr/share/opensearch/data
    networks:
      - app-network
    healthcheck:
      test: ["CMD-SHELL", "curl -s --fail http://localhost:9200/_cluster/health || exit 1"]
      interval: 20s
      timeout: 10s
      retries: 5
      start_period: 30s

  minio:
    image: minio/minio:RELEASE.2024-05-10T01-41-38Z
    container_name: dev-minio
    restart: unless-stopped
    env_file:
      - ./.env
    command: ["server", "/data", "--console-address", ":9001"]
    ports:
      - "${MINIO_PORT:-9000}:9000"
      - "${MINIO_CONSOLE_PORT:-9001}:9001"
    volumes:
      - minio_data:/data
    networks:
      - app-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/minio/health/ready"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 30s

  minio-bootstrap:
    image: minio/mc:RELEASE.2024-05-10T01-41-38Z
    container_name: dev-minio-bootstrap
    depends_on:
      minio:
        condition: service_healthy
    env_file:
      - ./.env
    entrypoint: /bin/sh -c "mc alias set local http://minio:9000 $$MINIO_ROOT_USER $$MINIO_ROOT_PASSWORD && (mc mb -p local/$$MINIO_DEFAULT_BUCKET || true) && mc anonymous set download local/$$MINIO_DEFAULT_BUCKET && mc ls local"
    networks:
      - app-network
    restart: "no"

networks:
  app-network:
    name: app-infra
    driver: bridge

volumes:
  postgres_data:
  redis_data:
  opensearch_data:
  minio_data:
