generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Organization {
  id          String   @id @default(cuid())
  name        String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // CRM configurations
  crmConfigurations CrmConfiguration[]
  
  // Business leads
  businessLeads BusinessLead[]
  
  // Field mappings
  fieldMappings FieldMapping[]
  
  // Sync jobs
  syncJobs SyncJob[]

  @@map("organizations")
}

model CrmConfiguration {
  id             String              @id @default(cuid())
  organizationId String
  organization   Organization        @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  
  crmType        CrmType
  isActive       Boolean             @default(false)
  credentials    Json // Encrypted credentials for CRM API
  
  createdAt      DateTime            @default(now())
  updatedAt      DateTime            @updatedAt

  @@map("crm_configurations")
}

model BusinessLead {
  id             String        @id @default(cuid())
  organizationId String
  organization   Organization  @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  
  // Lead information
  email          String
  firstName      String?
  lastName       String?
  phone          String?
  company        String?
  jobTitle       String?
  source         String?
  status         LeadStatus    @default(NEW)
  
  // Custom fields
  customFields   Json?
  
  // Metadata
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt

  // Sync relationships
  syncJobs       SyncJob[]

  @@unique([organizationId, email])
  @@map("business_leads")
}

model FieldMapping {
  id             String        @id @default(cuid())
  organizationId String
  organization   Organization  @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  
  crmType        CrmType
  sourceField    String        // BusinessLead field name
  targetField    String        // CRM field name
  fieldType      FieldType
  isRequired     Boolean       @default(false)
  defaultValue   String?
  
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt

  @@unique([organizationId, crmType, sourceField])
  @@map("field_mappings")
}

model SyncJob {
  id             String              @id @default(cuid())
  organizationId String
  organization   Organization        @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  businessLeadId String
  businessLead   BusinessLead        @relation(fields: [businessLeadId], references: [id], onDelete: Cascade)
  
  crmType        CrmType
  status         SyncJobStatus       @default(PENDING)
  errorMessage   String?
  
  // Request/response data
  requestData    Json?
  responseData   Json?
  
  // Timestamps
  createdAt      DateTime            @default(now())
  updatedAt      DateTime            @updatedAt
  completedAt    DateTime?

  @@map("sync_jobs")
}

enum CrmType {
  SALESFORCE
  HUBSPOT
  PIPEDRIVE
}

enum LeadStatus {
  NEW
  CONTACTED
  QUALIFIED
  CONVERTED
  CLOSED_LOST
}

enum FieldType {
  STRING
  NUMBER
  BOOLEAN
  DATE
  EMAIL
  PHONE
  PICKLIST
  TEXTAREA
}

enum SyncJobStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  RETRYING
}